#include <math.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <complex.h>

#include <omp.h>
#include <papi.h>

#define MULT 1024
#define DEPTH 4
#define RUNS 10

void fft_serial(complex *data, int len);
void fft_parallel(complex *data, int len, int depth);


void fft(complex *data, int len){

	#pragma omp parallel
	#pragma omp single nowait
	fft_parallel(data, len, 1);
}

void fft_serial(complex *data, int len){

	if(len>1){

		int i, halflen = len/2;
		double theta;
		double complex *odd, *even, w, tmp;

		even = (complex*)calloc(halflen, sizeof(complex));
		odd = (complex*)calloc(halflen, sizeof(complex));
	

		for(i=0;i<halflen;i++){
			even[i] = data[i*2];
			odd[i] = data[i*2+1];
		}
		
		fft_serial(even, halflen);
		fft_serial(odd, halflen);		

		for(i=0;i<halflen;i++){	
			theta = 2*M_PI*i/(double)len;
			w = cos(theta) + I*sin(theta);

			tmp = w*odd[i];
			data[    i    ] = even[i] + tmp;
			data[i+halflen] = even[i] - tmp;
		}

	
	}

}



void fft_parallel(complex *data, int len, int depth){

	if(len>1){

		int i, halflen = len/2;
		double theta;
		double complex *odd, *even, w, tmp;
		depth++;

		even = (complex*)calloc(halflen, sizeof(complex));
		odd = (complex*)calloc(halflen, sizeof(complex));
	

		for(i=0;i<halflen;i++){
			even[i] = data[i*2];
			odd[i] = data[i*2+1];
		}
		
		if( depth > DEPTH){
			fft_serial(even, halflen);
			fft_serial(odd, halflen);
		}		
		else{

			#pragma omp task shared(even)
			fft_parallel(even, halflen, depth);
			#pragma omp task shared(odd)
			fft_parallel(odd, halflen, depth);
			#pragma omp taskwait
		}

		#pragma omp parallel for
		for(i=0;i<halflen;i++){	
			theta = 2*M_PI*i/(double)len;
			w = cos(theta) + I*sin(theta);

			tmp = w*odd[i];
			data[    i    ] = even[i] + tmp;
			data[i+halflen] = even[i] - tmp;
		}
	
	}

}


double Cabs(double real, double imag){

	return sqrt(real*real + imag*imag);

}

void main(){


	double data[] = {
		1.000000, -0.001535, -0.999995, 0.004606, 0.999981, -0.007677, -0.999958, 0.010748, 
		0.999925, -0.013819, -0.999882, 0.016889, 0.999830, -0.019960, -0.999769, 0.023030, 
		0.999698, -0.026100, -0.999618, 0.029170, 0.999528, -0.032239, -0.999429, 0.035309, 
		0.999321, -0.038378, -0.999203, 0.041446, 0.999076, -0.044514, -0.998939, 0.047582, 
		0.998793, -0.050649, -0.998638, 0.053716, 0.998473, -0.056782, -0.998298, 0.059848, 
		0.998114, -0.062913, -0.997921, 0.065978, 0.997719, -0.069042, -0.997507, 0.072105, 
		0.997285, -0.075168, -0.997054, 0.078229, 0.996814, -0.081291, -0.996564, 0.084351, 
		0.996305, -0.087411, -0.996037, 0.090469, 0.995759, -0.093527, -0.995472, 0.096584, 
		0.995175, -0.099641, -0.994869, 0.102696, 0.994554, -0.105750, -0.994229, 0.108803, 
		0.993895, -0.111855, -0.993552, 0.114907, 0.993199, -0.117957, -0.992836, 0.121006, 
		0.992465, -0.124053, -0.992084, 0.127100, 0.991694, -0.130146, -0.991294, 0.133190, 
		0.990885, -0.136233, -0.990467, 0.139274, 0.990039, -0.142315, -0.989602, 0.145354, 
		0.989155, -0.148392, -0.988700, 0.151428, 0.988235, -0.154463, -0.987760, 0.157496, 
		0.987277, -0.160528, -0.986784, 0.163558, 0.986281, -0.166587, -0.985770, 0.169614, 
		0.985249, -0.172640, -0.984719, 0.175664, 0.984179, -0.178686, -0.983631, 0.181707, 
		0.983073, -0.184726, -0.982505, 0.187743, 0.981929, -0.190759, -0.981343, 0.193772, 
		0.980748, -0.196784, -0.980144, 0.199794, 0.979530, -0.202802, -0.978907, 0.205809, 
		0.978275, -0.208813, -0.977634, 0.211815, 0.976983, -0.214815, -0.976324, 0.217814, 
		0.975655, -0.220810, -0.974977, 0.223804, 0.974289, -0.226796, -0.973593, 0.229786, 
		0.972887, -0.232773, -0.972172, 0.235759, 0.971448, -0.238742, -0.970715, 0.241723, 
		0.969973, -0.244702, -0.969221, 0.247678, 0.968461, -0.250653, -0.967691, 0.253624, 
		0.966912, -0.256594, -0.966124, 0.259561, 0.965327, -0.262525, -0.964521, 0.265487, 
		0.963706, -0.268447, -0.962881, 0.271404, 0.962048, -0.274358, -0.961205, 0.277310, 
		0.960354, -0.280259, -0.959493, 0.283206, 0.958623, -0.286149, -0.957745, 0.289091, 
		0.956857, -0.292029, -0.955960, 0.294965, 0.955054, -0.297898, -0.954139, 0.300828, 
		0.953215, -0.303755, -0.952283, 0.306680, 0.951341, -0.309601, -0.950390, 0.312520, 
		0.949430, -0.315435, -0.948462, 0.318348, 0.947484, -0.321258, -0.946497, 0.324164, 
		0.945502, -0.327068, -0.944497, 0.329968, 0.943484, -0.332866, -0.942462, 0.335760, 
		0.941431, -0.338651, -0.940391, 0.341539, 0.939342, -0.344424, -0.938284, 0.347305, 
		0.937218, -0.350183, -0.936142, 0.353058, 0.935058, -0.355930, -0.933965, 0.358798, 
		0.932863, -0.361663, -0.931753, 0.364524, 0.930633, -0.367382, -0.929505, 0.370237, 
		0.928368, -0.373088, -0.927222, 0.375935, 0.926068, -0.378779, -0.924905, 0.381619, 
		0.923733, -0.384456, -0.922552, 0.387289, 0.921363, -0.390119, -0.920165, 0.392944, 
		0.918958, -0.395766, -0.917742, 0.398585, 0.916518, -0.401399, -0.915286, 0.404210, 
		0.914044, -0.407017, -0.912794, 0.409820, 0.911536, -0.412620, -0.910269, 0.415415, 
		0.908993, -0.418206, -0.907709, 0.420994, 0.906416, -0.423778, -0.905115, 0.426557, 
		0.903805, -0.429333, -0.902486, 0.432104, 0.901159, -0.434872, -0.899824, 0.437635, 
		0.898480, -0.440394, -0.897127, 0.443149, 0.895766, -0.445900, -0.894397, 0.448647, 
		0.893019, -0.451389, -0.891633, 0.454127, 0.890238, -0.456861, -0.888835, 0.459591, 
		0.887424, -0.462316, -0.886004, 0.465037, 0.884576, -0.467753, -0.883140, 0.470465, 
		0.881695, -0.473173, -0.880242, 0.475876, 0.878780, -0.478575, -0.877311, 0.481269, 
		0.875833, -0.483959, -0.874347, 0.486644, 0.872852, -0.489324, -0.871349, 0.492000, 
		0.869839, -0.494672, -0.868319, 0.497338, 0.866792, -0.500000, -0.865257, 0.502657, 
		0.863713, -0.505310, -0.862161, 0.507957, 0.860601, -0.510600, -0.859033, 0.513238, 
		0.857457, -0.515871, -0.855873, 0.518500, 0.854281, -0.521123, -0.852680, 0.523742, 
		0.851072, -0.526355, -0.849455, 0.528964, 0.847831, -0.531568, -0.846199, 0.534166, 
		0.844558, -0.536760, -0.842910, 0.539348, 0.841254, -0.541932, -0.839589, 0.544510, 
		0.837917, -0.547083, -0.836237, 0.549652, 0.834549, -0.552214, -0.832853, 0.554772, 
		0.831150, -0.557324, -0.829438, 0.559872, 0.827719, -0.562414, -0.825992, 0.564950, 
		0.824257, -0.567481, -0.822514, 0.570007, 0.820763, -0.572528, -0.819005, 0.575043, 
		0.817239, -0.577553, -0.815466, 0.580057, 0.813684, -0.582556, -0.811895, 0.585049, 
		0.810099, -0.587537, -0.808294, 0.590019, 0.806482, -0.592496, -0.804663, 0.594967, 
		0.802836, -0.597432, -0.801001, 0.599892, 0.799159, -0.602346, -0.797309, 0.604795, 
		0.795452, -0.607238, -0.793587, 0.609675, 0.791715, -0.612106, -0.789835, 0.614532, 
		0.787948, -0.616951, -0.786053, 0.619365, 0.784151, -0.621773, -0.782242, 0.624176, 
		0.780325, -0.626572, -0.778401, 0.628962, 0.776469, -0.631347, -0.774530, 0.633725, 
		0.772584, -0.636098, -0.770631, 0.638465, 0.768670, -0.640825, -0.766702, 0.643180, 
		0.764727, -0.645528, -0.762744, 0.647870, 0.760755, -0.650207, -0.758758, 0.652537, 
		0.756754, -0.654861, -0.754743, 0.657179, 0.752725, -0.659490, -0.750700, 0.661795, 
		0.748667, -0.664095, -0.746628, 0.666387, 0.744582, -0.668674, -0.742528, 0.670954, 
		0.740468, -0.673228, -0.738400, 0.675496, 0.736326, -0.677757, -0.734244, 0.680012, 
		0.732156, -0.682260, -0.730061, 0.684502, 0.727959, -0.686738, -0.725850, 0.688967, 
		0.723734, -0.691189, -0.721611, 0.693406, 0.719482, -0.695615, -0.717346, 0.697818, 
		0.715203, -0.700014, -0.713053, 0.702204, 0.710897, -0.704387, -0.708734, 0.706564, 
		0.706564, -0.708734, -0.704387, 0.710897, 0.702204, -0.713053, -0.700014, 0.715203, 
		0.697818, -0.717346, -0.695615, 0.719482, 0.693406, -0.721611, -0.691189, 0.723734, 
		0.688967, -0.725850, -0.686738, 0.727959, 0.684502, -0.730061, -0.682260, 0.732156, 
		0.680012, -0.734244, -0.677757, 0.736326, 0.675496, -0.738400, -0.673228, 0.740468, 
		0.670954, -0.742528, -0.668674, 0.744582, 0.666387, -0.746628, -0.664095, 0.748667, 
		0.661795, -0.750700, -0.659490, 0.752725, 0.657179, -0.754743, -0.654861, 0.756754, 
		0.652537, -0.758758, -0.650207, 0.760755, 0.647870, -0.762744, -0.645528, 0.764727, 
		0.643180, -0.766702, -0.640825, 0.768670, 0.638465, -0.770631, -0.636098, 0.772584, 
		0.633725, -0.774530, -0.631347, 0.776469, 0.628962, -0.778401, -0.626572, 0.780325, 
		0.624176, -0.782242, -0.621773, 0.784151, 0.619365, -0.786053, -0.616951, 0.787948, 
		0.614532, -0.789835, -0.612106, 0.791715, 0.609675, -0.793587, -0.607238, 0.795452, 
		0.604795, -0.797309, -0.602346, 0.799159, 0.599892, -0.801001, -0.597432, 0.802836, 
		0.594967, -0.804663, -0.592496, 0.806482, 0.590019, -0.808294, -0.587537, 0.810099, 
		0.585049, -0.811895, -0.582556, 0.813684, 0.580057, -0.815466, -0.577553, 0.817239, 
		0.575043, -0.819005, -0.572528, 0.820763, 0.570007, -0.822514, -0.567481, 0.824257, 
		0.564950, -0.825992, -0.562414, 0.827719, 0.559872, -0.829438, -0.557324, 0.831150, 
		0.554772, -0.832853, -0.552214, 0.834549, 0.549652, -0.836237, -0.547083, 0.837917, 
		0.544510, -0.839589, -0.541932, 0.841254, 0.539348, -0.842910, -0.536760, 0.844558, 
		0.534166, -0.846199, -0.531568, 0.847831, 0.528964, -0.849455, -0.526355, 0.851072, 
		0.523742, -0.852680, -0.521123, 0.854281, 0.518500, -0.855873, -0.515871, 0.857457, 
		0.513238, -0.859033, -0.510600, 0.860601, 0.507957, -0.862161, -0.505310, 0.863713, 
		0.502657, -0.865257, -0.500000, 0.866792, 0.497338, -0.868319, -0.494672, 0.869839, 
		0.492000, -0.871349, -0.489324, 0.872852, 0.486644, -0.874347, -0.483959, 0.875833, 
		0.481269, -0.877311, -0.478575, 0.878780, 0.475876, -0.880242, -0.473173, 0.881695, 
		0.470465, -0.883140, -0.467753, 0.884576, 0.465037, -0.886004, -0.462316, 0.887424, 
		0.459591, -0.888835, -0.456861, 0.890238, 0.454127, -0.891633, -0.451389, 0.893019, 
		0.448647, -0.894397, -0.445900, 0.895766, 0.443149, -0.897127, -0.440394, 0.898480, 
		0.437635, -0.899824, -0.434872, 0.901159, 0.432104, -0.902486, -0.429333, 0.903805, 
		0.426557, -0.905115, -0.423778, 0.906416, 0.420994, -0.907709, -0.418206, 0.908993, 
		0.415415, -0.910269, -0.412620, 0.911536, 0.409820, -0.912794, -0.407017, 0.914044, 
		0.404210, -0.915286, -0.401399, 0.916518, 0.398585, -0.917742, -0.395766, 0.918958, 
		0.392944, -0.920165, -0.390119, 0.921363, 0.387289, -0.922552, -0.384456, 0.923733, 
		0.381619, -0.924905, -0.378779, 0.926068, 0.375935, -0.927222, -0.373088, 0.928368, 
		0.370237, -0.929505, -0.367382, 0.930633, 0.364524, -0.931753, -0.361663, 0.932863, 
		0.358798, -0.933965, -0.355930, 0.935058, 0.353058, -0.936142, -0.350183, 0.937218, 
		0.347305, -0.938284, -0.344424, 0.939342, 0.341539, -0.940391, -0.338651, 0.941431, 
		0.335760, -0.942462, -0.332866, 0.943484, 0.329968, -0.944497, -0.327068, 0.945502, 
		0.324164, -0.946497, -0.321258, 0.947484, 0.318348, -0.948462, -0.315435, 0.949430, 
		0.312520, -0.950390, -0.309601, 0.951341, 0.306680, -0.952283, -0.303755, 0.953215, 
		0.300828, -0.954139, -0.297898, 0.955054, 0.294965, -0.955960, -0.292029, 0.956857, 
		0.289091, -0.957745, -0.286149, 0.958623, 0.283206, -0.959493, -0.280259, 0.960354, 
		0.277310, -0.961205, -0.274358, 0.962048, 0.271404, -0.962881, -0.268447, 0.963706, 
		0.265487, -0.964521, -0.262525, 0.965327, 0.259561, -0.966124, -0.256594, 0.966912, 
		0.253624, -0.967691, -0.250653, 0.968461, 0.247678, -0.969221, -0.244702, 0.969973, 
		0.241723, -0.970715, -0.238742, 0.971448, 0.235759, -0.972172, -0.232773, 0.972887, 
		0.229786, -0.973593, -0.226796, 0.974289, 0.223804, -0.974977, -0.220810, 0.975655, 
		0.217814, -0.976324, -0.214815, 0.976983, 0.211815, -0.977634, -0.208813, 0.978275, 
		0.205809, -0.978907, -0.202802, 0.979530, 0.199794, -0.980144, -0.196784, 0.980748, 
		0.193772, -0.981343, -0.190759, 0.981929, 0.187743, -0.982505, -0.184726, 0.983073, 
		0.181707, -0.983631, -0.178686, 0.984179, 0.175664, -0.984719, -0.172640, 0.985249, 
		0.169614, -0.985770, -0.166587, 0.986281, 0.163558, -0.986784, -0.160528, 0.987277, 
		0.157496, -0.987760, -0.154463, 0.988235, 0.151428, -0.988700, -0.148392, 0.989155, 
		0.145354, -0.989602, -0.142315, 0.990039, 0.139274, -0.990467, -0.136233, 0.990885, 
		0.133190, -0.991294, -0.130146, 0.991694, 0.127100, -0.992084, -0.124053, 0.992465, 
		0.121006, -0.992836, -0.117957, 0.993199, 0.114907, -0.993552, -0.111855, 0.993895, 
		0.108803, -0.994229, -0.105750, 0.994554, 0.102696, -0.994869, -0.099641, 0.995175, 
		0.096584, -0.995472, -0.093527, 0.995759, 0.090469, -0.996037, -0.087411, 0.996305, 
		0.084351, -0.996564, -0.081291, 0.996814, 0.078229, -0.997054, -0.075168, 0.997285, 
		0.072105, -0.997507, -0.069042, 0.997719, 0.065978, -0.997921, -0.062913, 0.998114, 
		0.059848, -0.998298, -0.056782, 0.998473, 0.053716, -0.998638, -0.050649, 0.998793, 
		0.047582, -0.998939, -0.044514, 0.999076, 0.041446, -0.999203, -0.038378, 0.999321, 
		0.035309, -0.999429, -0.032239, 0.999528, 0.029170, -0.999618, -0.026100, 0.999698, 
		0.023030, -0.999769, -0.019960, 0.999830, 0.016889, -0.999882, -0.013819, 0.999925, 
		0.010748, -0.999958, -0.007677, 0.999981, 0.004606, -0.999995, -0.001535, 1.000000
	};

	int len = sizeof(data)/sizeof(data[0]);

	complex *dataFFT;
	dataFFT = (complex*)calloc(len*MULT, sizeof(complex));	

	#pragma omp parallel for
	for(int k=0; k<MULT; k++){
		for(int i=0; i<len; i++){
			dataFFT[k*len+i] = data[i] + I*0;
		}
	}


	long long start, end;
	long long time=0;

	PAPI_library_init(PAPI_VER_CURRENT);


	for(int i=0; i<RUNS; i++){
		start = PAPI_get_real_usec();

		fft(dataFFT, len*MULT);

		end = PAPI_get_real_usec();
		time += end-start;
	}

	printf("Average time: %lld\n", time/RUNS);
}
